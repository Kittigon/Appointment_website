generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model users {
  id            Int              @id @default(autoincrement())
  email         String           @unique
  password      String
  name          String
  age           Int?
  gender        String?
  phone         String?          
  code          String?          
  role          Role             @default(USER)
  createdAt     DateTime         @default(now())
  updateAt      DateTime         @default(now())
  appointments  appointments[]
  reports       reportproblems[]
  notifications Notifications[]
}

model appointments {
  id            Int             @id @default(autoincrement())
  userId        Int
  date          String
  time          String
  description   String?
  status        Status          @default(PENDING)
  cancelReason  String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @default(now())
  code          String
  phone         String
  name          String
  user          users           @relation(fields: [userId], references: [id])
  notifications Notifications[]
}

model dass_21_result {
  id               Int             @id @default(autoincrement())
  user_id          String?         @db.VarChar(100)
  depression_score Int?
  anxiety_score    Int?
  stress_score     Int?
  depression_level String?
  anxiety_level    String?
  stress_level     String?
  created_at       DateTime?       @default(now()) @db.Timestamp(6)
  user_consent     user_consent?   @relation(fields: [user_id], references: [line_user_id], onDelete: Cascade, onUpdate: NoAction)
  notifications    Notifications[]
}

model documents {
  id        Int                    @id @default(autoincrement())
  content   String?
  embedding Unsupported("vector")?
}

model reportproblems {
  id            Int             @id @default(autoincrement())
  userId        Int
  type          String
  description   String?
  status        Reportstatus    @default(NEW)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @default(now())
  user          users           @relation(fields: [userId], references: [id])
  notifications Notifications[]
}

model chat_history {
  id           Int          @id @default(autoincrement())
  line_user_id String       @db.VarChar(100)
  role         String
  content      String
  timestamp    DateTime?    @default(now()) @db.Timestamptz(6)
  user_consent user_consent @relation(fields: [line_user_id], references: [line_user_id], onDelete: Cascade, onUpdate: NoAction)
}

model user_consent {
  line_user_id   String           @id @db.VarChar(100)
  name           String?
  phone          String?
  student_id     String?          @db.VarChar(20)
  consent        Boolean?
  granted_at     DateTime?        @db.Timestamp(6)
  allow_greeting Boolean?         @default(false)
  last_greeted   DateTime?        @db.Timestamp(6)
  tone_style     String?          @default("friendly") @db.VarChar(20)
  chat_history   chat_history[]
  dass_21_result dass_21_result[]
  notifications  Notifications[]
}

model DisabledDate {
  id        Int      @id @default(autoincrement())
  date      String // yyyy-mm-dd
  createdAt DateTime @default(now())
}

model Notifications {
  id Int @id @default(autoincrement())

  userId Int?
  user   users? @relation(fields: [userId], references: [id], onDelete: Cascade)

  line_user_id String?
  lineUser     user_consent? @relation(fields: [line_user_id], references: [line_user_id], onDelete: Cascade)

  type      String
  title     String
  message   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  // กรณีแจ้งเตือนเรื่องนัดหมาย
  appointmentId Int?
  appointment   appointments? @relation(fields: [appointmentId], references: [id])

  // กรณีแจ้งเตือนเรื่องความเสี่ยง (DASS-21)
  dass21Id Int?
  dass21   dass_21_result? @relation(fields: [dass21Id], references: [id])

  // กรณีแจ้งเตือนเรื่องแจ้งปัญหา
  reportId Int?
  report   reportproblems? @relation(fields: [reportId], references: [id])
}

enum Reportstatus {
  NEW
  IN_PROGRESS
  RESOLVED
  CANCELLED
}

enum Role {
  USER
  ADMIN
  MENTALHEALTH
}

enum Status {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
}
